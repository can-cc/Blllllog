title: 如何设计状态管理方案(一,思路篇)
date: 2020-05-12 17:26:54

---

我在另一篇文章中介绍了我们现在为什么要做状态管理[《为什么要做状态管理》
](https://www.chencanhao.com/Js/why-state-management)，这篇文章我们来聊聊该如何做好状态管理。首先分享一下设计状态管理方案的思路，因为我其实见过很多开发者，对状态管理的方案，用什么框架，工具，大部分时候都陷入迷茫，“我知道这个前端项目需要做好状态管理，但是不知道怎么去设计。”接下来给大家介绍一下我对状态管理设计的见解，希望能给需要的人参考。

## 一，确定你是否需要状态管理
如何设计状态管理最重要的是，你需要正确的认识到，自己即将要开发的前端系统是否需要全局，现代化的状态管理方案。

一般来说，如果你所开发的前端应用是一个服务端渲染应用，ajax 请求比较少，例如一个新闻网页，内容都是服务器渲染出来的，那么你不需要考虑状态管理，因为状态变化十分有限。

再或者，你所要开发的是一个偏营销的网站，你要设计很酷炫的动画，精妙的布局，来给消费者某种强烈的感官上冲击，那么你也大概不需要状态管理，同样的，这样的网站状态变化肯定不多，工作的重点是在视觉和交互上，如果在代码中使用了 redux 等方案，会显得十分奇怪，徒增复杂度。

当然，在复杂的页面上，例如，后台管理应用，商城类小程序或网页，聊天应用，大多数企业应用等等，这类系统有十分复杂且易变的状态，正确得使用状态管理方案会使代码架构更整洁，开发效率更高，代码更优雅。等等，或许你会说，我的应用很复杂，但是我没有使用状态管理，我使用了 service, 单例，hooks，graphql state，等等，嗯，事实上，这些种种方案，就是状态管理。

## 二，选择一个模式

近几年，前端的技术栈变化的非常块，迭代也很快。技术、框架、工具层出不穷。我见过一几个前端系统，由于开发迭代了很久，代码仓库集合了 redux，redux-observable，redux-saga，redux-axios-middle，graphql state，甚至开发者会说，redux 全局状态树不好，然后生成了子状态树，mobx 很火很不错，然后在某些页面上加入了 mobx。甚至有些开发成员在后端 DDD 思想中搬来了 repository，MVP 模式，在状态树前面继续包装。

oh，我的天，可千万不要这样做，且不论在一个代码上下文中同时使用那么多异构技术，**在一个代码上下文中，状态管理的方案只允许有一个**。

并且，项目开发人员应该清楚认识到，为什么这个项目的代码管理要这些用，这样写。

- 例如，redux 全局唯一状态树是为了保持变化只在一个地方发生，并维持简单，维持可预测性。
- graphql state 实际上就是在 graphql 内部做好了状态管理，你想要什么数据，BFF 或者内部的 state 已经帮你做好了，这样整个前端项目大部分只需要管好 UI 就行了。
- 而 MVP 事实上跟类 Flux 模式是互斥的，这两者使用了一个，就没必要用另者。

这些技术和方案，并不是说哪个比较好，哪个不好，redux好，flux不好之类的，这取决于你的情况。**我们所需要的，是确定好一个好的方案，选择一个模式，并写最好的代码，并在整个应用开发过程中，坚定不移的贯彻这种方案。** 千万不要写到一半，说这个地方用另一个更好，就轻易用了另一个方案，或者偷懒说这个地方直接请求数据渲染就好了啊，这是对架构和模式的破坏，应该杜绝这种行为，如果杜绝不了，那就换一个更好的方案，把之前的都重构掉。


## 分层
分层架构是服务端开发一个常用的设计模式，这种设计模式将代码按照层次逻辑分类，例如负责数据访问的逻辑划为数据访问层，负责展示UI的划为表现层，这种设计模式跟服务端开发的很多架构或者思想并不冲突，例如领域驱动模式，六边形架构等。事实上，前端在整个 web 系统中看，前端是属于展示层的。

## 三，边界
边界，也是软件设计中非常常见的一个词，在状态管理这里，边界值得是抽取状态管理的边界。

状态存在于任何地方，但我们并不是要把所有状态都放到状态管理方案中，这十分重要。**所以我们有必要把状态大致分为两类，一类是组件内状态，一种是全局状态。**

组件内状态不能放入状态管理中，举个例子，选择下拉框（Select）组件内的 isOpen 状态，想必应该没有人会把这些个状态放入状态管理方案中吧。这个例子很简单，那么我们在换一个例子，请求列表时候的 loading 状态，是否要放入状态管理中呢？分页状态信息，是否需要放进状态管理中呢。在开发过程中，很多时候会遇到是否需要放进状态管理中的思考，很多时候其实没有标准答案，这取决于你的代码设计，不过，在思考和判断的时候，需要反复问自己，这个组件是否是一个纯组件？如果是，那么这个组件就不应该涉及状态管理。这个状态是否跟随着组件的声明周期创建和销毁？语义上是否属于这个组件？如果是，则这个状态大概没必要放进状态管理，或者这个状态应该抽象到别的组件。

## 四，构建良好的测试
是的，如何做好状态管理还需要构建良好的测试，尤其是在大型项目，在长期维护的项目中更是至关重要。状态管理万变不离其宗，就是一个有限状态机，并且可预测，我们使用状态管理，就是在可预测的状态下，反应出不同的页面和元素。

所以我们状态管理后的状态是一个很确定的数据结构，我们根据这些准确的数据渲染出正确的页面，所以状态管理的正确性十分重要。并且状态如果集中起来处理，十分容易出错，并造成雪崩，也就是一个错会对其他状态数据造成破坏，很容易令整个页面崩溃。

所以，集中管理的状态测试是至关重要的，而状态测试也是最简单的，测试运行起来也是最高效的，因为状态管理必须纯粹，测试一个纯函数有一百种花里胡哨的方法，并能取得很好的效果。

